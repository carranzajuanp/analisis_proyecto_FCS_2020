class(datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`)
datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`<-
  as.factor(datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`)
table(datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`)
levels(datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`)

datos$ingreso<-
  datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`
  
         

datos$ingreso<-
  factor(datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`,
         levels=c("Menos de $25.000", "Entre $25000 y 55.000", "Entre $55.000 y $99.000",
                  "Entre $100.000 y $200.000", "Más de $200.000"))


table(datos$`6.1 Me puede decir en promedio, ¿Cuáles son los ingresos totales por mes en el hogar?`, 
      datos$ingreso)

datos$nse<-as.factor(datos$`Nivel Socio Económico`)

datos$nse<-factor(datos$nse, levels=c("01. Alto", "02. Medio alto", "03.Medio",
                                    "0.4 Medio Bajo", "0.5  Bajo"))
levels(datos$nse)<-c("Alto", "Medio alto", "Medio",
                    "Medio Bajo", "Bajo")
100*round(addmargins(prop.table(addmargins(table(datos$ingreso, datos$nse),2),2),1),3)
addmargins(table(datos$ingreso, datos$nse))

addmargins(prop.table(addmargins(table(datos$ingreso, datos$nse),2),2),1)

table(datos$`6.4 Ahora le voy a preguntar ¿qué pasó con los ingresos familiares durante la pandemia? Le voy a dar algunas opciones y debe indicarme una…`)
datos$cambio_ingresos<-as.factor(
  datos$`6.4 Ahora le voy a preguntar ¿qué pasó con los ingresos familiares durante la pandemia? Le voy a dar algunas opciones y debe indicarme una…`)

levels(datos$cambio_ingresos)<-c("aumento", "disminución", "variables",
                     "sin cambio, igual trabajo", "sin cambio, más trabajo")
table(datos$`6.4 Ahora le voy a preguntar ¿qué pasó con los ingresos familiares durante la pandemia? Le voy a dar algunas opciones y debe indicarme una…`, datos$cambio_ingresos)


100*round(addmargins(prop.table(addmargins(table(datos$cambio_ingresos, datos$nse),2),2),1),3)
addmargins(table(datos$cambio_ingresos, datos$nse))


# poner las variable sne una lista y
tablas_exploratorias[i] <- for (i in 5:8) {
    100*round(
    addmargins(
      prop.table(
        addmargins(
          table(
            datos[i], datos$nse),2),2),1),3)
  
}

u <- vector(mode = "list", length = 8)

rm(u)
for (i in 1:4) u<-list(table(datos[i]))


u
     

table(datos$"7.3 ¿El trabajo de la persona que aporta el ingreso principal en el hogar, es de…? (leer opciones)")
datos$tipo_trabajo<-
datos$tipo_trabajo<-as.factor(datos$`7.3 ¿El trabajo de la persona que aporta el ingreso principal en el hogar, es de…? (leer opciones)`)
table(datos$tipo_trabajo)

levels(datos$conformidad_trabajo_ahora)<-c("igual", "mejor", "peor")
table(datos$conformidad_trabajo_antes)
levels(datos$conformidad_trabajo_antes)<-c("igual", "mejor", "peor")
table(datos$`8.4 Actualmente, ¿cómo se siente con la situación laboral de su familia?`)


table(datos$`8.5 ¿Tuvieron durante la pandemia algunas de las siguientes dificultades para llevar adelante su trabajo?`)


datos<-separate(
  datos,
  `8.5 ¿Tuvieron durante la pandemia algunas de las siguientes dificultades para llevar adelante su trabajo?`,
  c("dificultad_1","dificultad_2",
    "dificultad_3","dificultad_4",
    "dificultad_5","dificultad_6","dificultad_7"),
  sep = ",",
  remove = FALSE,
  convert = FALSE,
  extra = "warn",
  fill = "warn")

datos$dificultad_1<-as.factor(datos$dificultad_1)
datos$dificultad_2<-as.factor(datos$dificultad_2)
datos$dificultad_3<-as.factor(datos$dificultad_3)
datos$dificultad_4<-as.factor(datos$dificultad_4)
datos$dificultad_5<-as.factor(datos$dificultad_5)
datos$dificultad_6<-as.factor(datos$dificultad_6)
datos$dificultad_7<-as.factor(datos$dificultad_7)


table(datos$`10.1 Cuando se presenta un problema de salud a Ud. o a un miembro de su familia, ¿acuden a?:`)


table(datos$`16.1 Durante la vigencia del aislamiento, ¿considera que la información obtenida sobre las medidas educativas en relación a los miembros de su hogar fue...?`)
table(datos$`La vivienda de su casa cuenta con [Cloacas]`, datos$nse)

sizes <- factor(sizes, levels = c("small", "medium", "large"))
table(datos$conformidad_trabajo_antes)
datos$conformidad_trabajo_antes<-
  factor(datos$conformidad_trabajo_antes, levels=c("Muy conforme", "Conforme", "Disconforme"))

###############

x <- list()rm(list=ls())
library(reshape2)
library(kableExtra)
library(tidyverse)
library(tidyselect)
datos_jp = read.table("datos_tablas.txt", header = T, sep = "\t")
datos_jp$X = NULL

i = 10
for(i in 2:ncol(datos_jp)){
  datos_ = datos_jp[,c(1,i)]
  datos_[[2]]= trimws(datos_[[2]], which = "l")
  datos_[[2]] = gsub(", ", ",", datos_[[2]])
  valores <- na.omit(unique(unlist(strsplit(as.character(datos_[[2]]), ","))))
  ver = separate(datos_, vars_pull(names(datos_), 2), into = as.character(c(1:length(valores))), sep =",")
  tabla = melt(ver, id.vars = c("nse"), na.rm = TRUE)
  
  
  tabla = kable_styling(column_spec(kable(100*round(
    addmargins(
      prop.table(
        addmargins(
          table(tabla$value, tabla$nse),
          2),2),1),3), 
    caption = paste("Variable - ",names(datos_)[[2]],"(porcentajes por NSE)")),  1, width="5cm"),
    latex_options = "HOLD_position")
  assign(paste0("tabla",i), tabla)
  x[[paste("Tabla de frecuencias relativas de la variable",names(datos_)[[2]])]] <- get(paste0("tabla",i))
  tabla
}
#################
?trimws
x <- list()
i = 10
for(i in 2:ncol(datos_jp)){
  datos_ = datos_jp[,c(1,i)]
  datos_[[2]]= trimws(datos_[[2]], which = "l")
  datos_[[2]] = gsub(", ", ",", datos_[[2]])
  valores <- na.omit(unique(unlist(strsplit(as.character(datos_[[2]]), ","))))
  ver = separate(datos_, vars_pull(names(datos_), 2), into = as.character(c(1:length(valores))), sep =",")
  tabla = melt(ver, id.vars = c("nse"), na.rm = TRUE)
  
  
  tabla = kable_styling(column_spec(kable(100*round(
    addmargins(
      prop.table(
        addmargins(
          table(tabla$value, tabla$nse),
          2),2),1),3), 
    caption = paste(names(datos_)[[2]],"(porcentajes por NSE)")),  1, width="5cm"),
    latex_options = "HOLD_position")
  assign(paste0("tabla",i), tabla)
  x[[paste("Tabla de frecuencias relativas de la variable",names(datos_)[[2]])]] <- get(paste0("tabla",i))
  tabla
}

##############
datos_ = datos_jp[,1]
datos_[[2]]= trimws(datos_[[2]], which = "l")
datos_[[2]] = gsub(", ", ",", datos_[[2]])
valores <- na.omit(unique(unlist(strsplit(as.character(datos_[[2]]), ","))))
ver = separate(as.data.frame(datos_), vars_pull(names(datos_), 2),
               into = as.character(c(1:length(valores))), sep =",")
tabla = melt(ver, id.vars = c("nse"), na.rm = TRUE)

tabla2


##################################################
load("G:/Mi unidad/proyecto_FCS_diciembre_2020/resultados/datos.Rda")
datos$nse<-as.factor(datos$`Nivel Socio Económico`)

datos$nse<-factor(datos$nse, levels=c("01. Alto", "02. Medio alto", "03.Medio",
                                      "0.4 Medio Bajo", "0.5  Bajo"))
levels(datos$nse)<-c("Alto", "Medio alto", "Medio",
                     "Medio Bajo", "Bajo")

table(datos$`3.2 Alguno de los integrantes del hogar tiene... (marcar todas las que señalen)`)


datos<-separate(datos, `3.2 Alguno de los integrantes del hogar tiene... (marcar todas las que señalen)`,
                into=c("cs1", "cs2", "cs3", "cs4"), sep = ",")

datos$cs1<- trimws(datos$cs1, which = "l")
datos$cs2<- trimws(datos$cs2, which = "l")
datos$cs3<- trimws(datos$cs3, which = "l")
datos$cs4<- trimws(datos$cs4, which = "l")


o1<-addmargins(table(datos$cs1, datos$nse),1)
o2<-addmargins(table(datos$cs2, datos$nse),1)
o3<-addmargins(table(datos$cs3, datos$nse),1)
o4<-addmargins(table(datos$cs4, datos$nse),1)

o1_sin_cobertura<-o1[1,]
o1_nsc<-o1[2,]
o1_obra_social<-o1[3,]
o1_otra<-o1[4,]
o1_pami<-o1[5,]
o1_prepaga_os<-o1[6,]
o1_prepaga_pago_voluntario<-o1[7,]
o1_PROFE<-o1[8,]
o1_total<-o1[9,]

o2_sin_cobertura<-o2[1,]
o2_obra_social<-o2[2,]
o2_otra<-o2[3,]
o2_prepaga_os<-o2[4,]
o2_prepaga_pago_voluntario<-o2[5,]
o2_PROFE<-o2[6,]
o2_total<-o2[7,]

o3
o3_sin_cobertura<-o3[1,]
o3_prepaga_os<-o3[2,]
o3_prepaga_pago_voluntario<-o3[3,]
o3_PROFE<-o3[4,]
o3_total<-o3[5,]

o4
o4_sin_cobertura<-o4[1,]
o4_total<-o4[2,]


sin_cobertura<-o1_sin_cobertura+o2_sin_cobertura+o3_sin_cobertura+
  o4_sin_cobertura
ns_nc<-o1_nsc
obra_social<-o1_obra_social+o2_obra_social
otra<-o1_otra+o2_otra
pami<-o1_pami
prepaga_os<-o1_prepaga_os+o2_prepaga_os+o3_prepaga_os
prepaga_voluntario<-o1_prepaga_pago_voluntario+o2_prepaga_pago_voluntario+
  o3_prepaga_pago_voluntario
profe<-o1_PROFE+o2_PROFE+o3_PROFE
total<-o1_total+o2_total+o3_total+o4_total

cobertura_salud<-rbind(obra_social, pami, prepaga_os, prepaga_voluntario, profe, otra, ns_nc,
      sin_cobertura, total)
cobertura_salud
cobertura_salud<-as.data.frame(cobertura_salud)

obra_social_porc<-100*round(cobertura_salud[1,]/cobertura_salud[9,],3)
pami_porc<-100*round(cobertura_salud[2,]/cobertura_salud[9,],3)
prepaga_os_porc<-100*round(cobertura_salud[3,]/cobertura_salud[9,],3)
prepaga_voluntario_porc<-100*round(cobertura_salud[4,]/cobertura_salud[9,],3)
profe_porc<-100*round(cobertura_salud[5,]/cobertura_salud[9,],3)
otra_porc<-100*round(cobertura_salud[6,]/cobertura_salud[9,],3)
ns_nc_porc<-100*round(cobertura_salud[7,]/cobertura_salud[9,],3)
sin_cobertura_porc<-100*round(cobertura_salud[8,]/cobertura_salud[9,],3)
total_porc<-100*round(cobertura_salud[9,]/cobertura_salud[9,],3)

cobertura_salud_porc<-rbind(obra_social_porc, pami_porc, prepaga_os_porc,
                            prepaga_voluntario_porc, profe_porc, otra_porc,
                            ns_nc_porc, sin_cobertura_porc, total_porc)
cobertura_salud_porc

# ayudas
table(datos[63])
datos$ayuda<-datos$`9.1 ¿Durante la pandemia, han solicitado algún tipo de ayuda en…?`
datos<-separate(datos$`9.1 ¿Durante la pandemia, han solicitado algún tipo de ayuda en…?`,
                into=c("ay1", "ay2", "ay3", "ay4", "ay5","ay6", "ay7", "ay8", "ay9", "ay10", "ay11"),
                sep = ",")

datos$ay1<- trimws(datos$ay1, which = "l")
datos$ay2<- trimws(datos$ay2, which = "l")
datos$ay3<- trimws(datos$ay3, which = "l")
datos$ay4<- trimws(datos$ay4, which = "l")
datos$ay5<- trimws(datos$ay5, which = "l")
datos$ay6<- trimws(datos$ay6, which = "l")
datos$ay7<- trimws(datos$ay7, which = "l")
datos$ay8<- trimws(datos$ay8, which = "l")
datos$ay9<- trimws(datos$ay9, which = "l")
datos$ay10<- trimws(datos$ay10, which = "l")
datos$ay11<- trimws(datos$ay11, which = "l")


o1<-addmargins(table(datos$cs1, datos$nse),1)
o2<-addmargins(table(datos$cs2, datos$nse),1)
o3<-addmargins(table(datos$cs3, datos$nse),1)
o4<-addmargins(table(datos$cs4, datos$nse),1)

o1_sin_cobertura<-o1[1,]
o1_nsc<-o1[2,]
o1_obra_social<-o1[3,]
o1_otra<-o1[4,]
o1_pami<-o1[5,]
o1_prepaga_os<-o1[6,]
o1_prepaga_pago_voluntario<-o1[7,]
o1_PROFE<-o1[8,]
o1_total<-o1[9,]

o2_sin_cobertura<-o2[1,]
o2_obra_social<-o2[2,]
o2_otra<-o2[3,]
o2_prepaga_os<-o2[4,]
o2_prepaga_pago_voluntario<-o2[5,]
o2_PROFE<-o2[6,]
o2_total<-o2[7,]

o3
o3_sin_cobertura<-o3[1,]
o3_prepaga_os<-o3[2,]
o3_prepaga_pago_voluntario<-o3[3,]
o3_PROFE<-o3[4,]
o3_total<-o3[5,]

o4
o4_sin_cobertura<-o4[1,]
o4_total<-o4[2,]


sin_cobertura<-o1_sin_cobertura+o2_sin_cobertura+o3_sin_cobertura+
  o4_sin_cobertura
ns_nc<-o1_nsc
obra_social<-o1_obra_social+o2_obra_social
otra<-o1_otra+o2_otra
pami<-o1_pami
prepaga_os<-o1_prepaga_os+o2_prepaga_os+o3_prepaga_os
prepaga_voluntario<-o1_prepaga_pago_voluntario+o2_prepaga_pago_voluntario+
  o3_prepaga_pago_voluntario
profe<-o1_PROFE+o2_PROFE+o3_PROFE
total<-o1_total+o2_total+o3_total+o4_total

cobertura_salud<-rbind(obra_social, pami, prepaga_os, prepaga_voluntario, profe, otra, ns_nc,
                       sin_cobertura, total)
cobertura_salud
cobertura_salud<-as.data.frame(cobertura_salud)

obra_social_porc<-100*round(cobertura_salud[1,]/cobertura_salud[9,],3)
pami_porc<-100*round(cobertura_salud[2,]/cobertura_salud[9,],3)
prepaga_os_porc<-100*round(cobertura_salud[3,]/cobertura_salud[9,],3)
prepaga_voluntario_porc<-100*round(cobertura_salud[4,]/cobertura_salud[9,],3)
profe_porc<-100*round(cobertura_salud[5,]/cobertura_salud[9,],3)
otra_porc<-100*round(cobertura_salud[6,]/cobertura_salud[9,],3)
ns_nc_porc<-100*round(cobertura_salud[7,]/cobertura_salud[9,],3)
sin_cobertura_porc<-100*round(cobertura_salud[8,]/cobertura_salud[9,],3)
total_porc<-100*round(cobertura_salud[9,]/cobertura_salud[9,],3)

cobertura_salud_porc<-rbind(obra_social_porc, pami_porc, prepaga_os_porc,
                            prepaga_voluntario_porc, profe_porc, otra_porc,
                            ns_nc_porc, sin_cobertura_porc, total_porc)
cobertura_salud_porc

table(datos$`14.6. Durante la pandemia¿ qué tipo de  continuidad educativa tuvieron? [Pre escolar]`)
table(datos$`4.2 En su casa cuentan con conectividad a internet a través de`)
datos$tipo_conexion<-
  as.factor(datos$`4.2 En su casa cuentan con conectividad a internet a través de`)
levels(datos$tipo_conexion)<-
  c("cableada", "cableada", "cableada", "cableada", "ninguna", "solo datos", 
    "cableada", "cableada", "cableada", "cableada", "cableada", "solo datos", 
    "datos y wifi compartido", "solo wifi compartido")


100*round(addmargins(prop.table(
  addmargins(table(
    datos$tipo_conexion, datos$nse),2),2),1),3)

table(datos$`4.3 En el último año, adquirieron nuevos paquetes o mejoraron el acceso a la conectividad?`,
      datos$nse)

datos$mejora_acceso_internet<-as.factor(datos$`4.3 En el último año, adquirieron nuevos paquetes o mejoraron el acceso a la conectividad?`)

datos$mejora_acceso_internet<-
  factor(datos$mejora_acceso_internet, levels=c("Sí", "No", "Ns/Nc"))

datos$mejora_acceso_internet <-droplevels(datos$mejora_acceso_internet)

100*round(addmargins(prop.table(
  addmargins(table(
    datos$mejora_acceso_internet, datos$nse),2),2),1),3)


# tamaño: grande (6 integrantes o más), no grande
# principal aportante: mujer varon No está la variable

table(is.na(datos$`Cuántas son menores de 14 años?`))
datos$`Cuántas son menores de 14 años?`[
  is.na(datos$`Cuántas son menores de 14 años?`)==TRUE]<-0
addmargins(table(datos$`Cuántas son menores de 14 años?`))


table(is.na(datos$`Cuántas tienen más de 60 años?`))
datos$`Cuántas tienen más de 60 años?`[
  is.na(datos$`Cuántas tienen más de 60 años?`)==TRUE]<-0
addmargins(table(datos$`Cuántas tienen más de 60 años?`))


datos$hogar_mas5<-
  ifelse(
    datos$`Cuántas personas viven en esa casa?`>5, 1, 0)
table(datos$`Cuántas personas viven en esa casa?`, datos$hogar_mas5)

datos$hogar_con_menores<-
  ifelse(datos$`Cuántas son menores de 14 años?`==0, 0, 1
  )
table(datos$`Cuántas son menores de 14 años?`, datos$hogar_con_menores)

datos$hogar_con_mayores<-
  ifelse(datos$`Cuántas tienen más de 60 años?`==0, 0, 1
  )
table(datos$`Cuántas tienen más de 60 años?`, datos$hogar_con_mayores)


datos$composicion<-
  datos$hogar_con_mayores+10*datos$hogar_con_menores+100*datos$hogar_mas5
table(datos$composicion)

datos$composicion<-
  as.factor(datos$composicion)



levels(datos$composicion)<-
  c(
    "no grande, sin menores, sin mayores", "no grande, sin menores, con mayores",
    "no grande, con menores, sin mayores", "no grande, con menores, con mayores",
    "grande, sin menores, sin mayores", "grande, sin menores, con mayores", 
    "grande, con menores, sin mayores", "grande, con menores, con mayores")


addmargins(table(datos$composicion))
